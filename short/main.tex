%% For double-blind review submission, w/o CCS and ACM Reference (max submission space)
\documentclass[acmtog,review,anonymous]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For double-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review,anonymous]{acmart}\settopmatter{printfolios=true}
%% For single-blind review submission, w/o CCS and ACM Reference (max submission space)
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true,printccs=false,printacmref=false}
%% For single-blind review submission, w/ CCS and ACM Reference
%\documentclass[acmsmall,review]{acmart}\settopmatter{printfolios=true}
%% For final camera-ready submission, w/ required CCS and ACM Reference
%\documentclass[acmsmall]{acmart}\settopmatter{}

%% Journal information
%% Supplied to authors by publisher for camera-ready submission;
%% use defaults for review submission.
\acmJournal{PACMPL}
\acmVolume{1}
\acmNumber{OOPSLA} % CONF = POPL or ICFP or OOPSLA
\acmArticle{1}
\acmYear{2021}
\acmMonth{1}
\acmDOI{} % \acmDOI{10.1145/nnnnnnn.nnnnnnn}
\startPage{1}

%% Copyright information
%% Supplied to authors (based on authors' rights management selection;
%% see authors.acm.org) by publisher for camera-ready submission;
%% use 'none' for review submission.
\setcopyright{none}
%\setcopyright{acmcopyright}
%\setcopyright{acmlicensed}
%\setcopyright{rightsretained}
%\copyrightyear{2018}           %% If different from \acmYear

%% Bibliography style
\bibliographystyle{ACM-Reference-Format}
%% Citation style
%% Note: author/year citations are required for papers published as an
%% issue of PACMPL.
\citestyle{acmnumeric}   %% For author/year citations


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Note: Authors migrating a paper from PACMPL format to traditional
%% SIGPLAN proceedings format must update the '\documentclass' and
%% topmatter commands above; see 'acmart-sigplanproc-template.tex'.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Some recommended packages.
\usepackage{booktabs}   %% For formal tables:
                        %% http://ctan.org/pkg/booktabs
\usepackage{subcaption} %% For complex figures with subfigures/subcaptions
                        %% http://ctan.org/pkg/subcaption

\input{macros}

\begin{document}

%% Title information
\title{Security Properties for Stack Safety}         %% [Short Title] is optional;
                                        %% when present, will be used in
                                        %% header instead of Full Title.
%\titlenote{with title note}             %% \titlenote is optional;
%                                        %% can be repeated if necessary;
%                                        %% contents suppressed with 'anonymous'
%\subtitle{Subtitle}                     %% \subtitle is optional
%\subtitlenote{with subtitle note}       %% \subtitlenote is optional;
%                                        %% can be repeated if necessary;
%                                        %% contents suppressed with 'anonymous'


%% Author information
%% Contents and number of authors suppressed with 'anonymous'.
%% Each author should be introduced by \author, followed by
%% \authornote (optional), \orcid (optional), \affiliation, and
%% \email.
%% An author may have multiple affiliations and/or emails; repeat the
%% appropriate command.
%% Many elements are not rendered, but should be provided for metadata
%% extraction tools.

%% Author with single affiliation.
%\author{Sean Noble Anderson}
%\authornote{with author1 note}          %% \authornote is optional;
%                                        %% can be repeated if necessary
%\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
%\affiliation{
%  \position{Position1}
%  \department{Computer Science}              %% \department is recommended
%  \institution{Portland State University}            %% \institution is required
%  \streetaddress{Street1 Address1}
%  \city{City1}
%  \state{State1}
%  \postcode{Post-Code1}
%  \country{Country1}                    %% \country is recommended
%}
%\email{ander28@pdx.edu}          %% \email is recommended

%\author{Leonidas Lampropoulos}
%\affiliation{
%  \institution{University of Maryland, College Park}
%}
%\email{leonidas@umd.edu}

%\author{Roberto Blanco}
%\affiliation{
%  \institution{Max Planck Institute for Security and Privacy}
%}
%\email{roberto.blanco@mpi-sp.org}

%\author{Benjamin C. Pierce}
%\affiliation{
%  \institution{University of Pennsylvania}
%}
%\email{bcpierce@cis.upenn.edu}

%\author{Andrew Tolmach}
%\affiliation{
%  \institution{Portland State University}
%}
%\email{tolmach@pdx.edu}

%
%%% Author with two affiliations and emails.
%\author{First2 Last2}
%\authornote{with author2 note}          %% \authornote is optional;
%                                        %% can be repeated if necessary
%\orcid{nnnn-nnnn-nnnn-nnnn}             %% \orcid is optional
%\affiliation{
%  \position{Position2a}
%  \department{Department2a}             %% \department is recommended
%  \institution{Institution2a}           %% \institution is required
%  \streetaddress{Street2a Address2a}
%  \city{City2a}
%  \state{State2a}
%  \postcode{Post-Code2a}
%  \country{Country2a}                   %% \country is recommended
%}
%\email{first2.last2@inst2a.com}         %% \email is recommended
%\affiliation{
%  \position{Position2b}
%  \department{Department2b}             %% \department is recommended
%  \institution{Institution2b}           %% \institution is required
%  \streetaddress{Street3b Address2b}
%  \city{City2b}
%  \state{State2b}
%  \postcode{Post-Code2b}
%  \country{Country2b}                   %% \country is recommended
%}
%\email{first2.last2@inst2b.org}         %% \email is recommended

%% Abstract
%% Note: \begin{abstract}...\end{abstract} environment must come
%% before \maketitle command
%\begin{abstract}
%What exactly does ``stack safety'' mean? The phrase is associated with a
%variety of compiler,
%run-time, and hardware mechanisms for protecting stack
%memory.  But these mechanisms typically lack precise specifications,
%relying instead on informal descriptions and examples of bad
%behaviors that they prevent.

%We propose a formal characterization
%of stack safety, formulated with concepts from language-based security: a
%combination of an integrity property (``the private
%state in each caller's stack frame is held invariant by the callee''),
%a confidentiality property (``the callee's behavior is insensitive to the
%caller's private state''), and a well-bracketedness property (``each
%callee returns control to its immediate caller'').

%We use these properties to validate the stack-safety ``micro-policies''
%proposed by~\citet{DBLP:conf/sp/RoesslerD18}.  Specifically, we check (with
%property-based random testing) that Roessler and Dehon's ``eager''
%micro-policy, which catches violations as early as possible, enforces a
%simple ``stepwise'' variant of our properties and correctly detects several
%broken variants, and that (a repaired version of) their more performant
%``lazy'' micro-policy corresponds to a slightly weaker and more extensional
%``observational'' variant of our properties.

%\end{abstract}


%% 2012 ACM Computing Classification System (CSS) concepts
%% Generate at 'http://dl.acm.org/ccs/ccs.cfm'.
\begin{CCSXML}
<ccs2012>
<concept>
<concept_id>10011007.10011006.10011008</concept_id>
<concept_desc>Software and its engineering~General programming languages</concept_desc>
<concept_significance>500</concept_significance>
</concept>
<concept>
<concept_id>10003456.10003457.10003521.10003525</concept_id>
<concept_desc>Social and professional topics~History of programming languages</concept_desc>
<concept_significance>300</concept_significance>
</concept>
</ccs2012>
\end{CCSXML}

%\ccsdesc[500]{Software and its engineering~General programming languages}
%\ccsdesc[300]{Social and professional topics~History of programming languages}
%% End of generated code


%% Keywords
%% comma separated list
\ifcameraready
\keywords{Stack Safety, Micro-Policies}  %% \keywords are mandatory in final camera-ready submission
\fi


%% \maketitle
%% Note: \maketitle command must come after title commands, author
%% commands, abstract environment, Computing Classification System
%% environment and commands, and keywords command.
\maketitle

%\section{Introduction}

The call stack is a perennial target for low-level attacks, leading to
consequences ranging from leakage or corruption of private stack data to
control-flow hijacking. To prevent or detect such attacks, a profusion of
software and hardware protections have been proposed,
%
including stack canaries~\citep{Cowan+98},
bounds checking~\citep{NagarakatteZMZ09,NagarakatteZMZ10,DeviettiBMZ08},
split stacks~\citep{Kuznetsov+14},
shadow stacks~\citep{Dang+15,Shanbhogue+19},
capabilities~\citep{Woodruff+14,Chisnall+15,SkorstengaardLocal,SkorstengaardSTK,Georges+21},
and hardware tagging~\citep{DBLP:conf/sp/RoesslerD18}.
%
The protections offered by such mechanisms are commonly described in terms
of concrete examples of attacks that they can prevent.
At best, they define stack safety by reference to an idealized machine that
is arguably stack safe by construction \citep{SkorstengaardSTK}.
But these mechanisms can be intricate, and it would be useful to have a precise, generic, and formal
specification for stack safety, both to compare the security claims of different
enforcement techniques and to rigorously validate such claims.

We propose such a characterization,
using the technical framework of language-based security.
Stack safety protects a caller from its callee, guaranteeing
the {\em integrity} and {\em confidentiality} of the caller's local state
until it regains control.

We formalize integrity and confidentiality as trace properties, in two different
variants: {\em stepwise} variants, in which a caller's data is {\em never}
read or modified during a call, and {\em observational} ones, in which
callees may read from and write to their caller's stack frame, as
long as these ``risky'' behaviors do not affect the system's observable
behavior. The observational properties are more extensional, and
any reasonable protection mechanism ought to enforce them,
even if it does not prevent every single dangerous read or write.

%SNA: will this audience know "hyperproperty?"
Confidentiality is especially interesting, as it is based on the traditional
notion of noninterference. But where noninterference is normally presented as an
end-to-end hyperproperty, stack confidentiality is noninterference applied over
multiple nested subtraces -- each individual call's behavior must be invariant
regardless of the state of the stack at its entry.

This formulation not only captures the intuition
that the callee cannot directly access the caller's state, but gives a novel
way of looking at control-flow attacks. We are not interested in attacks that
merely aim to execute arbitrary code -- in fact, our attacker model assumes
that the (attacking) callee may already execute arbitrary code.
%
By extension, we do not place any particular restrictions on control flow.
Perhaps suprisingly, we can still meaningfully distinguish the caller from
its callee, and talk about protecting the caller's data. After a call, control
is considered to belong to the callee until the trace reaches a valid
``return target,'' typically a state with the program counter at the next instruction
and the stack pointer restored. If the caller's data are accessed before then,
it is a violation of integrity or confidentiality.

These properties can optionally be extended with a notion of {\em well-bracketed control flow}
as in \citet{SkorstengaardSTK}, the system-wide control-flow property that callees always return
to their immediate caller, if they return at all. This property is largely orthogonal to our
data-protection properties.

To demonstrate the utility of our properties, we use them
to validate an existing mechanism, the
{\em stack-safety micro-policies} of~\citet{DBLP:conf/sp/RoesslerD18}, re-implemented
in the Coq proof assistant on top of a RISC-V specification. We
use QuickChick~\citep{Denes:VSL2014,Pierce:SF4}, a property-based testing
tool for Coq, to generate random programs and check
that these micro-policies correctly abort programs that
would violate stack safety. Furthermore, we check incorrect
enforcement variants (both variants that we accidentally created
during our re-implementation of the micro-policy and ones that we
intentionally crafted to be broken in order to increase our confidence
in testing and the enforcement mechanism itself). The testing framework
is able to generate counterexamples that violate our properties but are not halted by
incorrect enforcement mechanisms, increasing our confidence when it finds
no counterexamples under the real enforcement mechanisms.

Our testing supports the stack-safety claim of Roessler and Dehon's {\em Depth
  Isolation} micro-policy, in
which memory cells within each stack frame are tagged with the depth of
the function activation that owns the frame and access to those locations is
then permitted only when that activation is currently executing.
On the other hand, we find that their \emph{Lazy Tagging and Clearing} policy
violates the temporal aspect of confidentiality in
corner cases where data can leak across repeated calls to the same callee,
and also violates integrity if the leak happens to use the caller's frame. We
propose a variant of {\em Lazy Tagging and Clearing} that should enforce observational
integrity and confidentiality, albeit at some performance cost. The next step
is to expand testing to these properties and validate the variant; efficiently
testing observational properties presents unique challenges because a property
violation can be arbitrarily far removed from the initial ``risky'' read or write.

Finally, we demonstrate our model's flexibility by extending it to different settings.
First, we allow variables to be passed on the stack, allowing some of the state of
the caller to be shared with the callee (and potentially with a further
callee, and so on.) Then we expand the number of stacks as we move to a simple
coroutine model, albiet one with statically bounded regions for each stack.

In addition to testing lazy tag-based policies against our observational properties,
we are adapting the uninitialized capability model of \citet{Georges+21} to work with
our testing framework for validation against our properties. Of the several Cheri-based
stack protection schemes, its treatment of unitialized frames seems most compatible
with our model of confidentiality, without the need for expensive stack clearing
between calls. We expect that Cheri-based techniques support our properties if we
assume extra cooperation from callers, namely that they do not leak their capabilities
to the attacker. There is no equivalent dynamic requirement in a tag-based system because
the policy can dynamically enforce cooperation.

\bibliography{bcp.bib,local.bib}

%% Appendix
%\appendix
%\section{Appendix}
%Text of appendix \ldots

\end{document}
